select yyyyqq_as_of,
  sales_region as sales_region_2,
  sales_subregion as sales_subregion_2,
  case when amount_as_of < 1000 then "~ 1K" when amount_as_of < 5000 then "1K ~ 5K" when amount_as_of < 10000 then "5K ~ 10K" when amount_as_of < 25000 then "10K ~ 25K" else "25K ~" end as amount_band,
  case when marketing_lead_source = "Expansion" then "Expansion"
       when marketing_lead_source = "Outbound" then "Outbound"
       when marketing_lead_source in ( "BIME Trial","Chat Trial","Contact Us","Demo Request","Field","Gated Resource","Non-Trial Other","Social","Support Trial","Webinar Request" ) then "Inbound"
       else "Other" end as subtype_2,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 then amount_as_of end ) as created_as_of,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 then 1 end ) as created_as_of_count,
  string_agg( case when as_of_type = "Current doq" and created_quarter = 0 and amount_as_of >= 5000 then substr(id,1,15) end ) as created_as_of_ids,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 and close_quarter_as_of < 0 then amount_as_of end ) as created_as_of_prior,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 and close_quarter_as_of = 0 then amount_as_of end ) as inquarter_as_of,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 and close_quarter_as_of = 1 then amount_as_of end ) as created_as_of_next,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 and close_quarter_as_of = 2 then amount_as_of end ) as created_as_of_three,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 and close_quarter_as_of > 2 then amount_as_of end ) as created_as_of_four,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 then amount end ) as created,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 and probability = 1 then amount end ) as created_closed,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 and probability = 0 then amount end ) as created_lost,
  sum( case when as_of_type = "Current doq" and created_quarter = 0 and probability between .01 and .99 then amount end ) as created_open,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of = 1 then amount_as_of end ) as closed_as_of,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of = 1 then 1 end ) as closed_as_of_count,
  string_agg( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of = 1 and amount_as_of >= 5000 then substr(id,1,15) end ) as closed_as_of_ids,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of = 1 and close_quarter_rel_created < 0 then amount_as_of end ) as closed_as_of_prior,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of = 1 and close_quarter_rel_created = 0 then amount_as_of end ) as closed_as_of_inquarter,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of = 1 and close_quarter_rel_created = 1 then amount_as_of end ) as closed_as_of_next,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of = 1 and close_quarter_rel_created = 2 then amount_as_of end ) as closed_as_of_three,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of = 1 and close_quarter_rel_created > 2 then amount_as_of end ) as closed_as_of_four,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and created_quarter = 0 and probability_as_of = 1 then amount_as_of end ) as inquarter_as_of_closed,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and created_quarter = 0 and probability_as_of = 0 then amount_as_of end ) as inquarter_as_of_lost,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and created_quarter = 0 and probability_as_of between .01 and .99 then amount_as_of end ) as inquarter_as_of_open,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 then amount_as_of end ) as open_as_of,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 1 and probability_as_of between .01 and .99 then amount_as_of end ) as open_as_of_next,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 2 and probability_as_of between .01 and .99 then amount_as_of end ) as open_as_of_three,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of > 2 and probability_as_of between .01 and .99 then amount_as_of end ) as open_as_of_four,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 then 1 end ) as open_as_of_count,
  string_agg( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and amount_as_of >= 5000 then substr(id,1,15) end ) as open_as_of_ids,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 then amount end ) as `open`,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter = 0 and probability = 1 then amount end ) as open_closed,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter = 0 and probability = 0 then amount end ) as open_lost,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter != 0 then amount end ) as open_pushed,
  sum( case when as_of_type = "Current doq" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter = 0 and probability between .01 and .99 then amount end ) as open_open,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 then amount_as_of end ) as created_as_of_eoq,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 then 1 end ) as created_as_of_eoq_count,
  string_agg( case when as_of_type = "End of quarter" and created_quarter = 0 and amount_as_of >= 5000 then substr(id,1,15) end ) as created_as_of_eoq_ids,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 and close_quarter_as_of < 0 then amount_as_of end ) as created_as_of_eoq_prior,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 and close_quarter_as_of = 0 then amount_as_of end ) as inquarter_as_of_eoq,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 and close_quarter_as_of = 1 then amount_as_of end ) as created_as_of_eoq_next,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 and close_quarter_as_of = 2 then amount_as_of end ) as created_as_of_eoq_three,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 and close_quarter_as_of > 2 then amount_as_of end ) as created_as_of_eoq_four,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 then amount end ) as created_eoq,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 and probability = 1 then amount end ) as created_eoq_closed,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 and probability = 0 then amount end ) as created_eoq_lost,
  sum( case when as_of_type = "End of quarter" and created_quarter = 0 and probability between .01 and .99 then amount end ) as created_eoq_open,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter_rel_created = 1 then amount_as_of end ) as open_as_of_soq_1,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter_rel_created = 2 then amount_as_of end ) as open_as_of_soq_2,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter_rel_created = 3 then amount_as_of end ) as open_as_of_soq_3,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter_rel_created > 3 then amount_as_of end ) as open_as_of_soq_4,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 then 1 end ) as open_as_of_soq_count,
  string_agg( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and (amount_as_of >= 5000 or probability = 1) then substr(id,1,15) end ) as open_as_of_soq_ids,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 then amount end ) as open_soq,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter = 0 and probability = 1 then amount end ) as open_soq_closed,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter = 0 and probability = 0 then amount end ) as open_soq_lost,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter != 0 then amount end ) as open_soq_pushed,
  sum( case when as_of_type = "Quarter start" and close_quarter_as_of = 0 and probability_as_of between .01 and .99 and close_quarter = 0 and probability between .01 and .99 then amount end ) as open_soq_open
from `edw-prod-153420.strategy_analyst_general.pipeline`
group by yyyyqq_as_of, sales_region_2, sales_subregion_2, amount_band, subtype_2
order by 1 desc, 2, 3, 4, 6;
